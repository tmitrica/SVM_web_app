<!DOCTYPE html>
<html lang="ro">
<%- include("../fragmente/head") %>
<body class="bg-light">
    <%- include("../fragmente/header", {categorii: categorii}) %>

    <div class="container mt-5">
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-primary">Mașini de vânzare</h1>
        </div>

        <div>
            <!-- Sectiune Filtre -->
            <section class="filtre bg-white p-4 rounded-3 shadow-sm mb-5">
                <div class="row g-4">
                    <!-- Filtru Nume -->
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="filtru-nume" placeholder=" ">
                            <label for="filtru-nume">Nume mașină</label>
                        </div>
                    </div>

                    <!-- Filtru Pret -->
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card h-100 p-3">
                            <label class="form-label fw-medium mb-3">Interval preț (€)</label>
                            <input type="range" class="form-range mb-3" id="pret-min">
                            <input type="range" class="form-range" id="pret-max">
                            <div class="d-flex justify-content-between">
                                <span id="pret-min-afis" class="badge bg-primary"></span>
                                <span id="pret-max-afis" class="badge bg-primary"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Filtru Categorie -->
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card h-100 p-3">
                            <div class="form-floating">
                                <select class="form-select" id="filtru-categorie">
                                    <option value="">Toate categoriile</option>
                                    <% categorii.forEach(categorie => { %>
                                        <option value="<%= categorie %>"><%= categorie %></option>
                                    <% }) %>
                                </select>
                                <label for="filtru-categorie">Categorie</label>
                            </div>
                        </div>
                    </div>

                    <!-- Filtru Culoare -->
                    <div class="col-12">
                        <div class="card p-3">
                            <label class="form-label fw-medium mb-3">Culoare</label>
                            <div class="d-flex flex-wrap gap-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="culoare" id="culoare-toate" value="" checked>
                                    <label class="form-check-label" for="culoare-toate">Toate</label>
                                </div>
                                <% [...new Set(produse.map(p => p.culoare))].forEach(culoare => { %>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="culoare" id="culoare-<%= culoare %>" value="<%= culoare %>">
                                        <label class="form-check-label" for="culoare-<%= culoare %>"><%= culoare %></label>
                                    </div>
                                <% }) %>
                            </div>
                        </div>
                    </div>

                    <!-- Filtru Garantie -->
                    <div class="col-12">
                        <div class="card p-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="filtru-garantie">
                                <label class="form-check-label fw-medium" for="filtru-garantie">Cu garanție extensibilă</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Butoane Actiuni -->
                <div class="d-flex flex-wrap gap-3 justify-content-center mt-4">
                    <button class="btn btn-primary px-4" id="filtreaza">
                        <i class="bi bi-funnel me-2"></i>Filtrează
                    </button>
                    <button class="btn btn-outline-primary" id="sorteaza-asc">
                        <i class="bi bi-sort-alpha-down me-2"></i>A-Z
                    </button>
                    <button class="btn btn-outline-primary" id="sorteaza-desc">
                        <i class="bi bi-sort-alpha-up me-2"></i>Z-A
                    </button>
                    <button class="btn btn-success" id="calculeaza">
                        <i class="bi bi-calculator me-2"></i>Calculează
                    </button>
                    <button class="btn btn-danger" id="reseteaza">
                        <i class="bi bi-arrow-counterclockwise me-2"></i>Resetează
                    </button>
                </div>
            </section>

            <!-- Lista Produse -->
            <section class="produse-list row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
                <% produse.forEach(produs => { %>
                <div class="col">
                    <article class="produs card h-100 shadow-sm"
                        data-categorie="<%= produs.categorie_mare %>"
                        data-culoare="<%= produs.culoare %>"
                        data-pret="<%= produs.pret %>"
                        data-garantie="<%= produs.garantie_extensibila %>"
                        data-nume="<%= produs.nume.toLowerCase() %>">
                        
                        <div class="card-img-top ratio ratio-16x9">
                            <img src="../../resurse/imagini/<%= produs.imagine %>" 
                                 class="img-fluid object-fit-cover w-100 h-100"
                                 alt="<%= produs.nume %>">
                        </div>
                        
                        <div class="card-body d-flex flex-column">
                            <h2 class="card-title fs-5 fw-bold"><%= produs.nume %></h2>
                            <span class="badge bg-secondary mb-2"><%= produs.categorie_mare %></span>
                            <p class="card-text flex-grow-1"><%= produs.descriere %></p>
                            
                            <table class="table table-sm mb-3">
                                <tbody>
                                    <tr>
                                        <td class="fw-medium">Preț</td>
                                        <td class="text-end"><%= produs.pret %> €</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-medium">Kilometraj</td>
                                        <td class="text-end"><%= produs.kilometraj %> km</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-medium">Culoare</td>
                                        <td class="text-end"><%= produs.culoare %></td>
                                    </tr>
                                </tbody>
                            </table>

                            <a href="/produs/<%= produs.id %>" class="btn btn-primary w-100 mt-auto">
                                <i class="bi bi-info-circle me-2"></i>Detalii complete
                            </a>
                        </div>
                    </article>
                </div>
                <% }); %>
            </section>
        </div>
    </div>

    <%- include("../fragmente/footer") %>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const products = Array.from(document.querySelectorAll('.produse-list .col'));
            const pretMin = document.getElementById('pret-min');
            const pretMax = document.getElementById('pret-max');
            
            // Inițializare valori preț
            const preturi = products.map(p => parseInt(p.querySelector('.produs').dataset.pret));
            const minPrice = Math.min(...preturi);
            const maxPrice = Math.max(...preturi);
            
            pretMin.min = minPrice;
            pretMin.max = maxPrice;
            pretMin.value = minPrice;
            pretMax.min = minPrice;
            pretMax.max = maxPrice;
            pretMax.value = maxPrice;
            document.getElementById('pret-min-afis').textContent = minPrice;
            document.getElementById('pret-max-afis').textContent = maxPrice;

            // Funcție filtrare
            const aplicaFiltre = () => {
                const nume = document.getElementById('filtru-nume').value.toLowerCase();
                const pretMinVal = parseInt(pretMin.value);
                const pretMaxVal = parseInt(pretMax.value);
                const categorie = document.getElementById('filtru-categorie').value;
                const culoare = document.querySelector('input[name="culoare"]:checked').value;
                const garantie = document.getElementById('filtru-garantie').checked;

                products.forEach(produs => {
                    const data = produs.querySelector('.produs').dataset;
                    const matches = {
                        nume: data.nume.includes(nume) || nume === '',
                        pret: data.pret >= pretMinVal && data.pret <= pretMaxVal,
                        categorie: data.categorie === categorie || categorie === '',
                        culoare: data.culoare === culoare || culoare === '',
                        garantie: !garantie || data.garantie === 'true'
                    };
                    
                    produs.style.display = Object.values(matches).every(v => v) ? 'block' : 'none';
                });
            };

            // Evenimente
            pretMin.addEventListener('input', () => {
                document.getElementById('pret-min-afis').textContent = pretMin.value;
                aplicaFiltre();
            });

            pretMax.addEventListener('input', () => {
                document.getElementById('pret-max-afis').textContent = pretMax.value;
                aplicaFiltre();
            });

            document.querySelectorAll('#filtru-nume, #filtru-categorie, #filtru-garantie, input[name="culoare"]')
                .forEach(el => el.addEventListener('input', aplicaFiltre));

            // Sortare
            const sortProduse = (asc = true) => {
                const container = document.querySelector('.produse-list');
                const visibleProducts = products.filter(p => p.style.display !== 'none');
                
                visibleProducts.sort((a, b) => {
                    const numeA = a.querySelector('.card-title').textContent.toLowerCase();
                    const numeB = b.querySelector('.card-title').textContent.toLowerCase();
                    return asc ? numeA.localeCompare(numeB) : numeB.localeCompare(numeA);
                });

                container.innerHTML = '';
                visibleProducts.forEach(p => container.appendChild(p));
            };

            document.getElementById('sorteaza-asc').addEventListener('click', () => sortProduse(true));
            document.getElementById('sorteaza-desc').addEventListener('click', () => sortProduse(false));

            // Resetare
            document.getElementById('reseteaza').addEventListener('click', () => {
                pretMin.value = minPrice;
                pretMax.value = maxPrice;
                document.getElementById('pret-min-afis').textContent = minPrice;
                document.getElementById('pret-max-afis').textContent = maxPrice;
                document.getElementById('filtru-nume').value = '';
                document.getElementById('filtru-categorie').value = '';
                document.querySelector('#culoare-toate').checked = true;
                document.getElementById('filtru-garantie').checked = false;
                products.forEach(p => p.style.display = 'block');
                sortProduse(true);
            });

            // Calcul statistici
            document.getElementById('calculeaza').addEventListener('click', () => {
                const visibleProducts = products.filter(p => p.style.display !== 'none');
                const preturi = visibleProducts.map(p => parseInt(p.querySelector('.produs').dataset.pret));
                
                const suma = preturi.reduce((a, b) => a + b, 0);
                const medie = preturi.length ? (suma / preturi.length).toFixed(2) : 0;
                
                alert(`Statistici preț:\n
                    Total: ${suma} €\n
                    Medie: ${medie} €\n
                    Mașini afișate: ${visibleProducts.length}`);
            });
        });
    </script>
</body>
</html>